#!/usr/bin/env bash
set -e
[[ ! -f test/bats/bin/bats ]] && git submodule update --init --recursive

declare -rx TEST_BASH_VERSION="${TEST_BASH_VERSION:-"5.2"}"

case "${1:-}" in
  --alpine)
    DOCKER_BUILDKIT=1 docker build --build-arg BASH_VERSION="${TEST_BASH_VERSION}" --progress=plain \
      --target test -t sschmid/pw/test/alpine -f docker/alpine/Dockerfile .
    ;;
  --archlinux)
    DOCKER_BUILDKIT=1 docker build --progress=plain \
      --target test -t sschmid/pw/test/archlinux -f docker/archlinux/Dockerfile .
    ;;
  --debian)
    DOCKER_BUILDKIT=1 docker build --progress=plain \
      --target test -t sschmid/pw/test/debian -f docker/debian/Dockerfile .
    ;;
  --fedora)
    DOCKER_BUILDKIT=1 docker build --progress=plain \
      --target test -t sschmid/pw/test/fedora -f docker/fedora/Dockerfile .
    ;;
  --ubuntu)
    DOCKER_BUILDKIT=1 docker build --progress=plain \
      --target test -t sschmid/pw/test/ubuntu -f docker/ubuntu/Dockerfile .
    ;;
  *)
    test/bats/bin/bats "${@:-test}"
    test/shellcheck
    ;;
esac
